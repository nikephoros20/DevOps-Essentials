## Part 1. Инструмент **ipcalc**
### 1.1. Сети и маски
1) Адрес сети 192.167.38.54/13 - 192.160.0.0

![img](Screenshots/1.0.png)

2) Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную

255:

![img](Screenshots/1.1.png)

15:

![img](Screenshots/1.2.png)

11111111.11111111.11111111.11110000:

![img](Screenshots/1.3.png)

3) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4

![img](Screenshots/1.4.png)

/4

![img](Screenshots/1.5.png)

### 1.2. localhost

К приложению, работающему на localhost, можно обратиться по следующим адресам:

127.0.0.2

127.1.0.1 

Но нельзя по этим:

194.34.23.100 

128.0.0.1 

1.3. Диапазоны и сегменты сетей

10.0.0.45 - частный

134.43.0.2 - публичный

192.168.4.2 - частный

172.20.250.4 - частный

172.0.2.1 - публичный

192.172.0.1 - публичный

172.68.0.2 - публичный

172.16.255.255 - частный

10.10.10.10 - частный

192.169.168.1 - публичный

Следующие IP адреса возможно у сети 10.10.0.0/18:

10.10.0.2

10.10.10.10

10.10.1.255


Невозможны у следующих:

10.0.0.1

10.10.100.1

## Part 2. Статическая маршрутизация между двумя машинами

Используем ip a, чтобы просмотреть текущие сетевые интерфейсы

![img](Screenshots/2.2.png)

![img](Screenshots/2.3.png)

Задаем конкретные адреса для внутренней сети на обеих машинах, затем применяем изменения, смотрим, что получилось.

Для ws1

![img](Screenshots/2.4.png)

![img](Screenshots/2.5.png)

Для ws2

![img](Screenshots/2.6.png)

![img](Screenshots/2.7.png)

Добавляем статическое соединение между двумя машинами через ip r add

![img](Screenshots/2.8.png)
![img](Screenshots/2.9.png)

Пингуем соединение между машинами

![img](Screenshots/2.10.png)
![img](Screenshots/2.11.png)

Добавляем статическое соединение с сохранением

![img](Screenshots/2.12.png)
![img](Screenshots/2.13.png)

Пингуем соединение между машинами

![img](Screenshots/2.14.png)
![img](Screenshots/2.15.png)

## Part 3. Утилита **iperf3**

8 Мбит/с = 1 МБ/с
100 МБ/с = 800000 Кбит/с
1 Гбит/с = 1000 Мбит/с

Измерение скорости между двумя машинами с помощью iperf3

![img](Screenshots/3.1.png)
![img](Screenshots/3.2.png)

## Part 4. Сетевой экран

### 4.1. - 4.2 Утилита iptables и nmap

Файлы, имитирующие брандмауэр на двух машинах.

Логика команд следующая:

1)на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)

2)на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)

3)открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)

4)запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)

5)разрешить echo reply (машина должна "пинговаться")




![img](Screenshots/4.1.png)
![img](Screenshots/4.2.png)

Запуск файлов 

![img](Screenshots/4.3.png)
![img](Screenshots/4.4.png)

Пинг и nmap

![img](Screenshots/4.6.png)
![img](Screenshots/4,5,1.png)
![img](Screenshots/4.5.2.png)

В ws1 пинг будет запрещен, поскольку разрешение стоит после запрета. На ws2, напротив, он будет разрешен, поскольку разрешение находится в начале списка правил, то есть оно выполняется раньше запрета.

Для начала используетcя команду ping, чтобы найти машину, на которую нет ответа (то есть которая не "пингуется"), а затем используется утилита nmap, чтобы подтвердить, что хост этой машины действительно запущен. При выполнении данной проверки в выводе nmap должно быть указано: "Host is up".

## Part 5. Статическая маршрутизация сети

Настройка конфигурации сети (netplan) для пяти виртуальных машин

![img](Screenshots/5.0.png)
![img](Screenshots/5.1.png)
![img](Screenshots/5.2.png)
![img](Screenshots/5.3.png)
![img](Screenshots/5.4.png)

Перезапуск сервера сети и проверка того, что адреса заданы верны

![img](Screenshots/5.5.png)
![img](Screenshots/5.6.png)
![img](Screenshots/5.7.png)
![img](Screenshots/5.8.png)
![img](Screenshots/5.9.png)

Пингуем ws22 с ws21, r1 с ws11

![img](Screenshots/5.10.png)
![img](Screenshots/5.11.png)

### 5.2. Включение переадресации IP-адресов

Для включения переадресации используем следующую команду 

![img](Screenshots/5.14.png)
![img](Screenshots/5.15.png)

Чтобы сохранить включение переадресации вводим эту строку в sysctl.conf

![img](Screenshots/5.16.png)
![img](Screenshots/5.17.png)

### 5.3. Установка маршрута по-умолчанию

Настройка маршрута по умолчанию через изменение netplan

![img](Screenshots/5.18.png)
![img](Screenshots/5.19.png)
![img](Screenshots/5.20.png)

Вызываем ip r, чтобы проверить правильность настройки

![img](Screenshots/5.21.png)
![img](Screenshots/5.22.png)
![img](Screenshots/5.23.png)

Пингуем ws11 с r2, пинг доходит

![img](Screenshots/5.24.png)
![img](Screenshots/5.25.png)

### 5.4. Добавление статических маршрутов

Добавляем статические маршруты в нетплан

![img](Screenshots/5.26.png)
![img](Screenshots/5.27.png)

Вызываем ip r для проверки настройки

![img](Screenshots/5.28.png)
![img](Screenshots/5.29.png)

Запускаем следующие команды на ws11 для проверки выбора маршрутов

![img](Screenshots/5.30.png)

Был выбран первый вариант, так как он прописан в нетплане, в целом выбирается тот вариант, где маска длиннее. Более длинные адреса предпочтительны из-за большей точности. То есть, маршрут по умолчанию не используется, если есть другие варианты.

### 5.5. Построение списка маршрутизаторов

Для проверки входящих потоков запускаем следующую команду на r1

![img](Screenshots/5.32.png)
![img](Screenshots/5.33.png)
![img](Screenshots/5.34.png)
![img](Screenshots/5.35.png)

При помощи traceroute строится список маршрутизаторов от ws11 до ws21

![img](Screenshots/5.31.png)


### 5.6. Использование протокола ICMP при маршрутизации

Запускаем перехват сетевого трафика на r1 с помощью следующей команды.
Затем пингуем несуществующий адрес.

![img](Screenshots/5.36.png)
![img](Screenshots/5.37.png)

## Part 6. Динамическая настройка IP с помощью DHCP

Для r2 настраиваем в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP.
Также указываем адрес маршрутизатора, DNS-сервер и адрес внутренней сети.

![img](Screenshots/6.0.png)
![img](Screenshots/6.1.png)
![img](Screenshots/6.5.png)


Перезагружаем службу DHCP а также машину ws21 и проверяем её адрес, затем пингуем ws22 c ws21.

![img](Screenshots/6.2.png)
![img](Screenshots/6,3.png)
![img](Screenshots/6,4.png)
![img](Screenshots/6,5.png)
![img](Screenshots/6,6.png)

Теперь указываем МАС-адрес у ws11 через netplan. 

![img](Screenshots/6,8.png)

Конфигурацию сети для r1 настраиваем аналогично с r2, но с привязкой к MAC-адресу. После чего перезапускаем сервер.

![img](Screenshots/6,7.png)
![img](Screenshots/6,7,1.png)
![img](Screenshots/6,7,2.png)

Проверяем адрес, выданный ws11

![img](Screenshots/6,9.png)

Пингуем этот адрес с r1

![img](Screenshots/6,10.png)

Запрашиваем смену адреса ws21, перед этим удалив старый адрес. 
![img](Screenshots/6,5.png)
![img](Screenshots/6,11.png)
![img](Screenshots/6,12.png)

В этой части были использованы следующие опции протокола DHCP:

Опция routers ip-address [, ip-address...]; указывает адреса шлюзов для клиентской сети. Маршрутизаторы обязательно должны быть перечислены в порядке предпочтительности.

Опция domain-name-servers ip-address [, ip-address...]; описывает список DNS серверов, доступных для клиента. Сервера также следует перечислять в порядке предпочтительности.

## Part 7. NAT

Меняем файл /etc/apache2/ports.conf на ws22 и r1, делая сервер Apache2 общедоступным.

![img](Screenshots/7.1.png)
![img](Screenshots/7.2.png)

Запускаем Apache2 серверы с данными параметрами

![img](Screenshots/7.3.png)
![img](Screenshots/7.4.png)

Меняем файл, имитирующий брандмауэр на r2. Затем запускаем файл с этими командами. После этого пингуем ws22 с r1, пинг не проходит.

![img](Screenshots/7.5.png)
![img](Screenshots/7.6.png)
![img](Screenshots/7.8.png)

Суть изменений в удалении правил в таблице filter, NAT, а также установка отбрасывания всех маршрутизируемых пакетов.

Затем добавляем еще одно правило - разрешить маршрутизацию всех пакетов протокола ICMP. Запускаем файл и проверяем пинг между ws22 и r1.

![img](Screenshots/7.9.png)
![img](Screenshots/7.10.png)
![img](Screenshots/7.12.png)

Включаем SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0).

Включаем DNAT на 8080 порт машины r2 и добавляем к веб-серверу Apache, запущенному на ws22, доступ извне сети.

![img](Screenshots/7.13.png)

Проверяем соединение TCP для SNAT, подключаясь с ws22 к r1, затем наоборот

![img](Screenshots/7.14.png)
![img](Screenshots/7,15.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels

Запускаем на r2 фаервол с правилами из Части 7.

Запускаем веб-сервер Apache на ws22 только на localhost (изменяем строку Listen 80 на Listen localhost:80 в файле /etc/apache2/ports.conf). Запускаем сервер и проверяем статус.

![img](Screenshots/8.1.png)
![img](Screenshots/8.2.png)

Воспользуемся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21. Для проверки используем команду telnet. Затем выходим из удаленного терминала.

![img](Screenshots/8.5.1.png)
![img](Screenshots/8.4.png)
![img](Screenshots/8.5.2.png)
![img](Screenshots/8.6.png)
![img](Screenshots/8.9.png)

Воспользуемся Remote TCP forwarding с ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11. Для проверки используем команду telnet. Затем выходим из удаленного терминала.

![img](Screenshots/8.7.png)
![img](Screenshots/8.8.png)
![img](Screenshots/8.10.png)
